# 開発者ノート

## 優先度Aタスク実施報告

以下の優先度Aタスクがすべて完了しました。

1.  **モノレポ初期セットアップ**: `packages/web-game-client` および `packages/api-server` ディレクトリの作成と、ルート `package.json` でのワークスペース設定が完了しました。
    *   **コメント**: `run_shell_command` ツールの `directory` パラメータと `npm` ワークスペースの連携に一部課題があり、`npm create` や `npm install` の実行に試行錯誤がありましたが、最終的には手動での実行と`npm install --workspace`コマンドの適切な利用により解決しました。

2.  **共通スキーマ定義**: `specs/game_state.json` を作成し、ゲームの状態、プレイヤー、カード、アクションの基本的なデータ構造を定義しました。
    *   **コメント**: このスキーマは、フロントエンドとバックエンド間のデータ整合性を保つ上で非常に重要です。今後の機能追加や変更の際には、このスキーマを常に最新の状態に保つ必要があります。

3.  **`NullAuthAdapter` の実装**: `packages/web-game-client/src/auth/AuthAdapter.ts` インターフェースと `packages/web-game-client/src/auth/NullAuthAdapter.ts` クラスを実装しました。これにより、認証なしの初期フェーズでも一意の `clientId` を管理できるようになりました。
    *   **コメント**: 将来的にFirebase Authenticationを導入する際に、この抽象レイヤーがスムーズな移行を可能にします。

4.  **Local Game Engine (TypeScript) とユニットテストの実装**: `packages/web-game-client/src/types.ts` で型定義を行い、`packages/web-game-client/src/game/engine.ts` でゲームエンジンの骨組みを実装しました。また、`packages/web-game-client/src/game/engine.test.ts` で基本的なユニットテストを作成し、パスすることを確認しました。
    *   **コメント**: Jestの設定で `jest.config.js` を `jest.config.cjs` にリネームする必要がありましたが、これは `package.json` の `"type": "module"` 設定によるものです。ゲームエンジンのロジックはまだプレースホルダーですが、テストが整備されたことで、今後の機能追加が安全に行える基盤ができました。

5.  **Hand UI (Reactコンポーネント) の実装**: `packages/web-game-client/src/components/HandView.tsx` を作成し、`packages/web-game-client/src/App.tsx` に統合しました。これにより、プレイヤーの手札がUIに表示されるようになりました。
    *   **コメント**: 現時点ではカードの見た目はシンプルですが、Phaser 3との統合や、カードの選択・無効化ロジックの実装に向けての足がかりとなります。

## 今後の開発に向けたコメント

*   **Realtime Database連携**: 次の優先タスクであるRealtime Databaseラッパーの実装は、クライアントとサーバー間のデータ同期の核となります。Firebaseの`firebaseConfig`情報が提供され次第、すぐに着手可能です。
*   **ゲームロジックの具体化**: 現在のゲームエンジンは骨組みのみです。カードの効果（資金獲得、買収、防衛、詐欺）を具体的に実装し、ターンの進行ロジック（資金獲得フェイズ、ドローフェイズ、アクションフェイズ）を完成させる必要があります。
*   **NPC AI**: NPCのAIロジックは、ゲームの面白さに直結します。重み付け行動型のAIを実装する際には、ゲームの状態を適切に評価し、戦略的な選択ができるように設計することが重要です。
*   **Phaser 3統合**: UIとゲーム描画の分離は良い設計ですが、Phaser 3でのカードのアニメーションやインタラクションの実装は、ゲームの体験を大きく左右します。
*   **テストの拡充**: 今後、ゲームロジックが複雑になるにつれて、ユニットテストだけでなく、統合テストやE2Eテストの導入も検討すべきです。
*   **ユーザーからの情報提供**: `TODO.md`の「確認事項・提供物」セクションにあるFirebase情報、カード画像、詳細な勝利条件の定義は、今後の開発をスムーズに進める上で不可欠です。これらの情報提供にご協力をお願いいたします。

---
以上、優先度Aタスクの完了報告と今後の開発に関するコメントです。

## 追記：フェーズ2以降の主要タスク進捗報告

### 12. ゲームロジックの実装 (ターンの進行、カード効果、勝敗判定) - 完了

*   `engine.ts`にターンの進行ロジック（資金獲得フェイズ、ドローフェイズ）を実装しました。
*   各カード（資金集め、買収、防衛、詐欺）の基本的な効果を`src/game/cards/`配下に実装しました。
*   `engine.ts`の`resolveActions`メソッドを改良し、カードのコストチェック、手札から捨て札への移動、カード効果の適用ロジックを組み込みました。
*   「買収カード同士の相打ち」ルールを含む、基本的な競合解決ロジックを`resolveActions`内に実装しました。
*   勝利条件のチェック（不動産が0になった場合）のプレースホルダーを追加しました。

### 13. カード選択UIのインタラクティブ化とコストチェック - 完了

*   `HandView.tsx`のカードをクリック可能にし、選択されたカードのIDを`App.tsx`に渡すようにしました。
*   `App.tsx`に`selectedCardId`の状態管理と`handleCardSelect`関数を実装しました。
*   プレイヤーの資金とカードのコストに基づいて、プレイ可能なカードをUI上で視覚的に区別し、選択できないカードは無効化するようにしました。
*   「Play Turn」ボタンは、カードが選択されるまで無効化されます。

### 14. Realtime Databaseとのゲーム状態同期 - 完了

*   `App.tsx`をFirebase Realtime Databaseと連携させました。
*   `NullAuthAdapter`を使用して`clientId`を生成し、`createMatch`関数で新しいマッチを作成（または既存のマッチに参加）し、`matchId`を管理するようにしました。
*   `realtimeClient.ts`に`watchGameState`関数を追加し、`App.tsx`がRealtime Databaseからゲーム状態の更新をリアルタイムで監視するようにしました。
*   `handlePlayTurn`メソッドは、プレイヤーとシミュレートされたNPCのアクションを`putAction`関数を使ってRealtime Databaseに書き込むようになりました。
*   Realtime Databaseのリスナーが両プレイヤーのアクションを検知すると、`engine.advanceTurn()`と`engine.applyAction()`が呼び出され、ゲームの状態が更新されてDBに書き戻されるようになりました。

### 解決済みの主要なエラー

*   **`ReferenceError: ref is not defined`**: `realtimeClient.ts`に`watchGameState`関数を追加し、`App.tsx`のインポート文を修正することで解決しました。
*   **`TypeError: Cannot read properties of undefined (reading 'length')`**: `HandView.tsx`で`hand`プロップが常に配列として扱われるように修正することで解決しました。
*   **`ERROR: Expected ";" but found "resolveActions"`**: `engine.ts`内のメソッドの重複定義と誤ったネストを修正し、ファイルをクリーンな状態に上書きすることで解決しました。

---
以上、ここまでの開発進捗と主要なエラー解決に関する報告です。

## 追記：GitHub Actions CIワークフローの修正報告

*   **ルートの`package.json`ファイルが見つからないエラーの解決**:
    *   GitHub Actions上で`npm install`が`package.json`を見つけられないエラーが発生しました。これは、ローカル環境で`package.json`が消失していたことが原因でした。
    *   ルートに`package.json`ファイルを再作成し、正しいワークスペース設定を記述することで解決しました。
*   **`engine.test.ts`の引数エラーの解決**:
    *   `engine.test.ts`内の`engine.applyAction`の呼び出しで、引数の数が不足しているエラーが発生しました。
    *   `applyAction`メソッドが2つの引数を取るように変更されたことに合わせて、テストコードも2つの引数を渡すように修正しました。
*   **`engine.ts`の構文エラーの解決**:
    *   `engine.ts`内でメソッドが誤ってネストされていた構文エラーが継続して発生していました。
    *   `engine.ts`ファイルを正しい内容で完全に上書きすることで、重複したメソッド定義と誤ったネストを解消し、エラーを解決しました。

これらの修正により、GitHub ActionsのCIワークフローが正常に動作し、フロントエンドのテストが自動で実行されるようになりました。

## 追記：フェーズ2以降の追加タスク進捗報告 (続き)

### 16. デッキ構築UIの実装 (フロントエンド) - 完了

*   `packages/web-game-client/src/components/DeckBuilder.tsx`を作成し、利用可能なカードの表示、デッキへの追加・削除機能を持つ基本的なUIを実装しました。
*   `packages/web-game-client/src/components/GameView.tsx`を作成し、既存のゲームUIロジックを`App.tsx`から分離しました。
*   `packages/web-game-client/src/App.tsx`を修正し、`GameView`と`DeckBuilder`コンポーネントを切り替えられるナビゲーション（ボタン）を追加しました。

### 17. カード画像表示の統合 (HandViewなど) - 完了

*   `packages/web-game-client/src/components/HandView.tsx`および`packages/web-game-client/src/components/DeckBuilder.tsx`を修正し、カードの`templateId`に対応する画像（`public/images/cards/`配下）を表示するようにしました。
*   `packages/web-game-client/src/components/GameView.tsx`を修正し、Firebase Realtime Databaseから`CardTemplate`データを`fetchCardTemplates`で取得し、`HandView`に渡すようにしました。
*   **Firebase Realtime Databaseへのデータ投入**: `CARD_TEMPLATES`のJSONデータをFirebase Realtime Databaseの`/cards/v1/templates`パスに手動で投入しました。
*   **初期手札表示の修正**: アプリ起動時に「Your Hand: No cards in hand.」と表示される問題を解決しました。`GameView.tsx`の初期化ロジックを修正し、初期ゲーム状態をDBに書き込む前に`GameEngine.advanceTurn()`を呼び出すことで、プレイヤーが初期手札を持つようにしました。
*   **画像ファイル名の修正**: `templateId`と画像ファイル名が一致していなかった問題を、ユーザーに画像ファイル名を`templateId`に合わせて変更していただくことで解決しました。

### 解決済みの主要な問題 (続き)

*   **Firebaseデータ上書き問題**: `cards`データをインポートした際に既存の`matches`データが消滅する問題が発生しましたが、これはインポート方法の誤り（ルートでの上書き）が原因でした。`matches`データが動的に再生成されることを利用し、`cards`データを再インポートし、フロントエンドアプリを再起動することで共存状態を確立しました。
*   **カード画像が表示されない問題**: 画像ファイル名が`templateId`と一致していなかったため、画像が表示されませんでした。ユーザーに画像ファイル名を`templateId`に合わせて変更していただくことで解決しました。
*   **初期手札表示の修正**: アプリ起動時に「Your Hand: No cards in hand.」と表示される問題を解決しました。`GameView.tsx`の初期化ロジックを修正し、初期ゲーム状態をDBに書き込む前に`GameEngine.advanceTurn()`を呼び出すことで、プレイヤーが初期手札を持つようにしました。

---
以上、ここまでの開発進捗と主要な問題解決に関する報告です。

## 追記：フェーズ2完了報告とフェーズ3に向けた準備

`TODO.md`に記載されていたフェーズ2のタスクがすべて完了しました。以下に主要な達成項目と、その過程で解決した問題点をまとめます。

### 18. Phaserでのゲーム要素描画 (プレイヤー、不動産、場札) - 完了

*   ReactコンポーネントからPhaserシーンへ`gameState`を連携する仕組みを確立しました。(`game.registry`を利用)
*   `MainGameScene.ts`を大幅に改良し、`gameState`の変更を検知して、プレイヤーの資金・不動産情報や、場に出されたカードの画像などを動的に描画するようにしました。
*   カード画像のアセットを`preload`で動的に読み込むようにし、ゲームのアニメーション（カードのフェードインなど）の基礎を実装しました。

### 19. デッキ管理APIの実装 (バックエンド) - 完了

*   FastAPIを用いて、デッキを管理するための基本的なAPIエンドポイント (`/decks`) を構築しました。
*   Pydanticモデル (`Deck`, `CardInDeck`) を定義し、リクエストとレスポンスのデータ構造を明確化しました。
*   当面はインメモリの辞書をデータベースとして使用しますが、将来的にFirebase等へ拡張可能な設計としました。

### 20. サーバーサイドゲームロジックの骨組み構築 (FastAPI) - 完了

*   クライアント側のTypeScript製`GameEngine`に対応する、Python版`GameEngine`のスケルトンを`api-server`側に作成しました。
*   これにより、将来的にサーバー主導の権威あるゲームロジック（特にPvPモードで重要）へ移行するための基盤が整いました。

### 22. GitHub Actions CIワークフローで実施するテストカバレージの最適化 - 完了

*   Jestの設定を更新し、`--coverage`フラグによってテストカバレッジレポートが自動生成されるようにしました。
*   カバレッジ向上のため、`engine.ts`の`applyAction`メソッドに対するより具体的なテストケースを追加し、テストの信頼性を高めました。

### 解決済みの主要な問題 (続き)

*   **ゲームオーバーループ問題**: ゲームが終了してもターンが進行し続ける問題を、`GameEngine`と`GameView`の両方にガード処理を追加することで解決しました。
*   **CIテストの失敗**: `GameEngine`のコンストラクタ変更後にテストが失敗する問題を、テストコード側で正しい`gameState`を注入するように修正して解決しました。

* UI/UXとPhaserアニメーションの洗練（タスク27）の続き:
       * game-rootの画面全体スケーリングと中央寄せの調整。
       * App.cssとmain.tsxの修正によるレイアウト調整。
       * nav-panelとgame-panelのレイアウトと色調整。
       * top-barとplayer-areaのパディング削除と位置調整。
       * hud.opponent-hudとtop-barの重なり解消。
       * GameボタンとDeck Builderボタンのスタイリング。
       * Phaser Canvasのサイズ調整と、phaser-game-containerのdivとlaunch呼び出しに関するデバッグと修正。
       * Phaser Canvas内のturnInfoTextの非表示化。
       * 未解決の問題: カードアニメーションが表示されない問題（lastActionsがPhaserに正しく伝わらない問題）。

## 追記：カードアニメーションの不具合修正報告

長らく未解決となっていた「カードアニメーションが表示されない問題」について、原因の特定と修正が完了しました。

### 発生していた問題

1.  **1ターン目のアニメーション不具合**: 両プレイヤーがカードを提出しても、片方のカードのアニメーションしか再生されない。
2.  **NPCのカードが表示されない**: アニメーション中に、NPC側のカードが表示されない。
3.  **勝敗表示の不具合**: ゲームが終了しても、「You Win / You Lose」のメッセージが表示されない。

### 根本原因

これらの問題はすべて、ゲームエンジン(`engine.ts`)の`resolveActions`メソッドにおける、**状態管理の設計不備**に起因していました。

具体的には、ターンの結果を処理する際に、現在のゲーム状態を直接変更（ミューテーション）していました。これにより、プレイヤー1の処理がプレイヤー2の処理に意図せず影響を与え、プレイヤー2の手札からカードが見つからなくなる、という深刻な副作用が発生していました。その結果、エンジンが返すアクション履歴(`lastActions`)が不完全なものとなり、アニメーションの不具合を引き起こしていました。

### 修正内容

*   **ゲームエンジンのリファクタリング**:
    *   `engine.ts`の`applyAction`メソッドの設計を全面的に見直し、**イミュータブル（不変）な状態管理**を導入しました。
    *   ターンの処理を行う際は、まず現在のゲーム状態の完全なコピーを作成し、すべての処理（コスト計算、効果適用など）をそのコピーに対して行います。
    *   これにより、処理の途中で元の状態が破壊されることがなくなり、常に安全で予測可能な結果を保証できるようになりました。

*   **アニメーションロジックの単純化**:
    *   問題の切り分けのため、`MainGameScene.ts`のカードアニメーションを一時的にシンプルなもの（移動演出の省略）に修正しました。根本原因の解決に伴い、今後より洗練された演出に戻すことも可能です。

### 結果

この修正により、上記のアニメーションに関するすべての問題が解決され、両プレイヤーのカードが正しく表示されるようになりました。長期間にわたりご迷惑をおかけしましたが、ご協力のおかげで、より堅牢で安定したゲームエンジンの基盤を構築することができました。

### 2025年8月14日 開発報告

今回の開発スプリントでは、ユーザー体験の向上とゲームの安定性・品質向上に焦点を当てました。特に、テストカバレッジを大幅に向上させたことで、今後の機能追加やバランス調整をより安全かつ迅速に行うための強固な基盤が整いました。

---

### 📝 主な開発内容

#### 1. ゲームログの日本語化とフォーマット統一
* **内容**: ゲーム内で表示されるすべてのログメッセージを英語から日本語に翻訳し、フォーマットを「プレイヤーは「（カード名）」をプレイした」という形式に統一しました。
* **改善**: 各ターンの出来事が直感的に理解できるようになり、ログ管理も`engine.ts`に集約されたことで容易になりました。

#### 2. UI/UXの改善
* **最新ログの強調表示**: ゲームログの最新項目を太字で明るく表示することで、視覚的に区別できるようにしました。
* **UIのクリーン化**: ログエリアの見出しを削除し、より洗練されたシンプルなデザインにしました。

#### 3. ゲームバランスの調整
* **ターン毎の資金増加ルールの変更**: ユーザーフィードバックに基づき、ターン開始時の自動資金増加ルールを撤廃しました。これにより、カードプレイの戦略性がさらに重要になります。

#### 4. テストの拡充と品質向上
* **テストカバレッジの大幅向上**: ゲームエンジンのテストファイル(`engine.test.ts`)を拡充しました。
* **テストシナリオ追加**: 「買収」対「防衛」、「買収」対「詐欺」といった競合シナリオや、山札が尽きた際のシャッフル、ゲーム終了条件などのエッジケースを含むテストを追加しました。
* **バグ修正**: テスト拡充の過程で発見された「片方のプレイヤーがカードを出さない場合にゲームが停止するバグ」を修正し、エンジンの安定性を向上させました。

### 2025年8月15日 開発報告

クライアントとサーバーで一貫したゲーム体験を提供するため、サーバーサイドにPython製のゲームエンジンを実装しました。

---

### 🛠️ サーバーサイドゲームエンジンの実装 (フェーズ3)

#### 1. データ構造のPython化 (タスク23a)
* **内容**: TypeScriptで定義されていたゲームの状態を、Pythonの**Pydanticモデル**として`api-server/app/game/models.py`に再定義しました。
* **効果**: Pydanticによる厳密な型チェックが可能になり、サーバーサイドでのデータの一貫性と信頼性が向上しました。

#### 2. カード効果ロジックの移植 (タスク23b)
* **内容**: 各カードの効果を処理する関数を、TypeScriptからPythonへ個別に移植し、`api-server/app/game/cards/`配下に整理しました。
* **効果**: クライアントとサーバーでカード効果の処理が完全に一致するようになりました。

#### 3. ゲームエンジン本体の移植 (タスク23c)
* **内容**: ターンの進行、アクションの解決、勝利条件の判定といった核となるロジックを`GameEngine`クラスとして`api-server/app/game/engine.py`に実装しました。
* **効果**: これにより、サーバー単体でゲームを進行できる基盤が整いました。

#### 4. サーバーサイドの単体テスト実装 (タスク23d)
* **内容**: Python版`GameEngine`が正しく動作することを保証するため、`pytest`を用いて包括的なユニットテストを`api-server/tests/test_engine.py`に作成しました。
* **効果**: クライアント側のテストケースを網羅することで、両エンジンのロジックの一貫性を担保しました。

#### 5. CI（継続的インテグレーション）の強化
* **内容**: GitHub ActionsのCIワークフローを更新し、プッシュ時にフロントエンドとバックエンド両方のテストが自動で実行されるようにしました。
* **効果**: プロジェクト全体の安定性が向上しました。

---

### 🚀 フェーズ3タスクの完了と問題解決

* **ゲームエンジンを呼び出すAPIエンドポイント作成 (タスク23e)**: FastAPIバックエンドに、ゲームエンジンの主要なメソッドを呼び出すAPIエンドポイントを実装しました。
* **デッキ管理APIのデータベース接続 (タスク24)**: デッキ管理APIを、インメモリデータベースから**Firebase Realtime Database**に移行しました。
    * **解決した問題**: `firebase-admin`パッケージの不足を`requirements.txt`に追加することで解決。また、認証情報は**.envファイル**と`.gitignore`を使い、安全に管理する仕組みを導入しました。
* **デッキ構築UIとAPIの統合 (タスク25)**: フロントエンドのデッキ構築UIが、バックエンドのデッキ管理APIと連携し、デッキの作成、読み込み、更新が可能になりました。
    * **解決した問題**: **Vite開発サーバーのプロキシ設定**を修正し、フロントエンドからバックエンドへのAPIリクエストが正しく転送されるようにしました。

### 2025年8月15日 開発報告 (描画問題の課題と今後の対策方針)

長らく課題となっていた描画問題について、原因の特定と解決策の検討を行いました。

---

### 🚧 未解決の描画問題

現在も残っている主な視覚的な問題は、**Phaserコンテナの高さがゼロに崩壊する**ことです。

*   **根本原因の分析**: これは、CSSのFlexboxレイアウト、特に高さの伝播に関する問題です。
    *   親コンテナが`display: flex; flex-direction: column;`であるにもかかわらず、子要素である`.main-area`に適切な高さが伝わっていません。
    *   `.main-area`が`height: 100%`を持っていても、親の高さが厳密に定義されていない場合、ゼロに縮小する可能性があります。
*   **解決策の仮説**: `App.css`の`.main-area`に`flex-grow: 1`と`min-height: 0`を正しく適用することで、この問題は解決されるはずです。`flex-grow`は残りのスペースを占有する役割を、`min-height: 0`は親の高さに応じて縮小することを許可する役割を担います。

### 2025年8月15日 開発報告 (描画問題の解決と後続エラーの修正)

上記の描画問題について、原因の特定と修正を完了しました。それに伴い発生した複数の問題も解決しています。

---

### ✅ 修正内容の詳細

#### 1. Phaserコンテナの縮小問題の解決
*   **原因**: `#phaser-game-container`自体の**CSSサイズが未定義**だったことが真の原因でした。
*   **修正**: CSSルールに`width: 100%`, `height: 100%`, `aspect-ratio`などを追加し、コンテナが親要素内で正しくサイズを確保するようにしました。

#### 2. 空白のキャンバス問題の解決
*   **原因**: ReactのStrictModeによるコンポーネントの再マウント時に、Phaserゲームインスタンスが再作成されない**ロジックの欠陥**が`GameView.tsx`にありました。
*   **修正**: `isFirstMountRef`のロジックを削除し、`useEffect`フックを単純化することで、Phaserインスタンスが常に正しく再生成されるようにしました。

#### 3. Canvasのサイズ不一致問題の解決
*   **原因**: Phaserの初期化コンフィグが固定ピクセルサイズ（1000x600）を基準にしていたため、動的なサイズ変更に追従できていませんでした。
*   **修正**: Phaserのコンフィグの`scale`設定を`width: '100%'`, `height: '100%'`に変更し、親コンテナのサイズにフィットするようにしました。

#### 4. ランタイムエラーの解決
*   **原因**: `GameEngine`クラスに、UIから呼び出される`getPlayableCards`メソッドが実装されていませんでした。
*   **修正**: `engine.ts`に`getPlayableCards`メソッドを新規追加し、`GameView.tsx`の呼び出し箇所を修正しました。

### 2025年8月16日 開発報告 (UI/UXの微調整とPhaser連携の安定化)

前回の報告以降、UI/UXのさらなる改善と、ReactとPhaser間の連携を安定させるための修正を行いました。

---

### UIレイアウトと表示ロジックの修正

*   **トップバーの削除**: ゲーム画面上部のトップバーを削除し、垂直方向のスペースを確保しました。
*   **Phaserキャンバスのサイズ調整**: Phaserキャンバスの基準サイズを**1000x600から800x480に縮小**し、UI全体のバランスを調整しました。
*   **ゲームログの表示改善**:
    *   **表示件数の制限**: 最新の6件のみを表示するようにロジックを修正しました。
    *   **レイアウト崩れの防止**: ログエリアに固定の高さを設定し、自動スクロールを有効にしました。
    *   **新規ログの強調表示**: 「現在のターンで発生したすべてのログ」を強調表示するようにロジックを変更しました。

### Phaser連携の安定化とリファクタリング

*   **Phaserシーンのリファクタリング**: `MainGameScene.ts`に残っていた古いHUD描画ロジックを削除し、Phaserの責務を「カードアニメーションとゲームオーバー表示」に限定しました。
*   **Reactストリクトモードに関する明確化**: 開発環境でPhaserが複数回読み込まれる現象は、Reactの**ストリクトモード**による意図的な動作であり、製品版では発生しないことを確認しました。

---

### 2025年8月17日 開発報告 (タイトル画面とUIの最終調整)

UIの視覚的な品質と操作性を向上させるため、以下の最終調整を行いました。

---

### タイトル画面の改修

*   **フォントの変更**: タイトルロゴに毛筆系のWebフォント「**Yuji Syuku**」を適用し、ゲームのテーマに沿ったデザインに変更しました。
*   **メイン画像の表示**: タイトルロゴと「ゲーム開始」ボタンの間にメイン画像を追加し、画面の訴求力を高めました。
*   **ボタンのスタイル統一**: 「ゲーム開始」ボタンのスタイルを他のUIボタンと統一感のあるデザインに刷新しました。

### UIの操作性向上

*   **ナビゲーションの強調表示**: 現在選択されているビュー（「対戦！」または「デッキ構築」）のボタンが強調表示されるようにしました。
*   **暫定メニューの追加**: 将来的な拡張を見据え、「チュートリアル」「プロローグ」「スタッフクレジット」のプレースホルダーとなるボタンをナビゲーションパネルに無効状態で追加しました。
*   **HUDの縁取り色の変更**: ゲーム画面のHUDの縁取りを、プレイヤー側を緑、対戦相手側を赤に変更し、カードの縁取り色と連動させました。

### 2025年8月16日 開発報告 (UI/UXの微調整とPhaser連携の安定化 - 続き)

前回の報告以降、UI/UXのさらなる改善と、ReactとPhaser間の連携を安定させるための修正を行いました。

---

#### 1. カードアイテムの挙動調整
*   **選択状態でのクリックによる選択解除**: `HandView.tsx`において、選択状態のカードを再度クリックすることで選択が解除されるように変更しました。
*   **選択状態でのホバー無効化**: `App.css`を修正し、選択状態のカードにマウスオーバーしてもホバーエフェクトが発生しないようにしました。

#### 2. 「資金集め」ボタンの追加と挙動調整
*   **ボタンの追加**: 「Play Turn」ボタンの上に、同じサイズで「資金集め」ボタンを追加しました。
*   **スタイリング**: `App.css`を修正し、「資金集め」ボタンが`card-item`と同様のホバー・選択時の挙動を持ち、かつ「Play Turn」ボタンと同じ高さになるように調整しました。
*   **レイアウト調整**: `App.css`の`action-bar`の`flex-direction`を`column`に変更し、ボタン間の`gap`を設定することで、「資金集め」ボタンが「Play Turn」ボタンの上に配置され、両ボタンの合計の高さが`game-log-area`や`hand-container`と同じになるように調整しました。また、`action-bar`に`flex-grow: 1`を追加し、横幅にフィットするようにしました。
*   **選択解除挙動**: 「資金集め」ボタンも、選択状態での再度クリックで選択解除されるように変更しました。
*   **ゲームロジック連携**: 「資金集め」ボタンが選択された状態で「Play Turn」ボタンが押された場合、ゲーム内部で「資金集め」カードが使用されたものとして処理されることを確認しました。

#### 3. Phaser連携の改善
*   **カード画像のプリロード**: `MainGameScene.ts`の`create`メソッドに`loadCardImages`イベントのリスナーを追加し、`GameView.tsx`から`cardTemplates`が利用可能になった時点でこのイベントを発行するように変更しました。これにより、ゲーム開始時にすべてのカード画像をプリロードし、アニメーション中のちらつきを解消しました。
*   **Phaser内の不動産表示の削除**: HUDに情報が含まれているため、Phaserコンテナ内の「不動産：N」表示を削除しました。これに伴い、`MainGameScene.ts`から関連するプロパティ、メソッド、イベントリスナーを削除し、`GameView.tsx`からの`updateGameState`イベントの発行も停止しました。

---
### 2025年8月16日 開発報告 (資金集めのコマンド化)

ゲームの戦略性とUIの明確化のため、これまでの「資金集め」カードを、手札とは独立した**常に選択可能なコマンド**へと変更しました。この修正により、初期資金とデッキ構成も調整されます。

---

### 🛠️ フェーズ1: コアゲームロジックの調整

この変更は、以下のファイルに影響します。

* **`packages/web-game-client/src/types.ts`**:
    * `CardTemplate['type']`から`'GAIN_FUNDS'`を削除し、`Action`インターフェースを拡張して`actionType: 'play_card' | 'collect_funds'`を追加します。これにより、カードをプレイしたのか、コマンドを実行したのかを明確に区別できるようになります。

* **`packages/web-game-client/src/game/cards/gain_funds.ts`**:
    * 「資金集め」がカードではなくなるため、このファイルを削除します。

* **`packages/web-game-client/src/game/engine.ts`**:
    * **`createInitialState`**:
        * 初期デッキを**買収、防衛、詐欺**の3種類のカードで構成されるように変更します（それぞれ3枚ずつ、合計9枚）。
        * 初期資金を2から**0**に変更します。
    * **`resolveActions`**:
        * `action.actionType`が`'collect_funds'`の場合、プレイヤーの資金を**+1**するロジックを追加します。このコマンドは手札や捨て札を消費しません。
        * Phaserでの表示のため、`cardTemplateId: 'COLLECT_FUNDS_COMMAND'`という特別なIDを解決済みアクションに含めます。

### 🎨 フェーズ2: UIの調整

ユーザー体験を向上させるためのUI変更は以下の通りです。

* **`packages/web-game-client/src/components/HandView.tsx`**:
    * 手札のカードに加えて、**常に選択可能な「資金集め」コマンドのUI要素**を実装します。これは見た目上カードのように見えますが、クリックすると「資金集め」アクションをトリガーし、`{ actionType: 'collect_funds' }`というアクションオブジェクトを返します。
    * このコマンドは常にプレイ可能な状態（無効化されない）で表示されます。

* **`packages/web-game-client/src/game/scenes/MainGameScene.ts`**:
    * `lastActions`に`cardTemplateId: 'COLLECT_FUNDS_COMMAND'`が含まれている場合、特別な**「資金集め」カード画像をフリップアニメーションと共に表示**するようにします。このカードは捨て札には移動しません。

### ✅ フェーズ3: テストとクリーンアップ

変更の信頼性を確保するため、以下のテストとクリーンアップを実施します。

* **`packages/web-game-client/src/game/engine.test.ts`**:
    * 初期状態（資金、デッキサイズ）の変更に合わせて既存のテストを更新します。
    * 「資金集め」コマンドに関する新しいテストを追加し、資金が増加すること、手札や捨て札に影響がないことを確認します。
    * 不要になった`GAIN_FUNDS`カードに関するテストを削除します。

 ### 開発報告 (2025年8月16日)

「鹿王院エリザベスの地上げですわ！」のゲームシステム変更（GEMINI.mdの最新情報に基づく）と、それに伴うコード修正、および発生した問題の解決を行いました。

---

### 実施フェーズと主な変更点

#### フェーズ1: コアゲームロジックの調整

* **`packages/web-game-client/src/types.ts`**:
    * `CardTemplate['type']`から`'GAIN_FUNDS'`を削除しました。
    * `Action`インターフェースを`actionType`を含むように変更し、`cardId`をオプション化しました。
* **`packages/web-game-client/src/game/engine.ts`**:
    * `createInitialState`を修正し、初期デッキサイズを9枚（3種各3枚）に、プレイヤーの初期資金を0に設定しました。
    * 「資金集め」コマンドのロジックを`resolveActions`に直接実装しました（資金+1、手札/捨て札に影響なし）。
    * `getCardInfo`を修正し、`collect_funds`アクションを適切に処理するようにしました。
    * `applyGainFunds`のインポートと使用を削除しました。
* **`packages/web-game-client/src/game/cards/gain_funds.ts`**: ファイルを削除しました。

#### フェーズ2: UIの調整

* **`packages/web-game-client/src/components/HandView.tsx`**:
    * `onCardSelect`の型定義を`Action`オブジェクトを受け取るように変更しました。
    * `HandViewProps`に`playerId`を追加し、既存カードの`onClick`ハンドラを修正しました。
    * **当初追加した「資金集め」コマンドのUI要素を削除しました（既存ボタンを使用するため）。**
* **`packages/web-game-client/src/components/GameView.tsx`**:
    * `handleCardSelect`を修正し、`Action`オブジェクトを受け取り`selectedCardId`を更新するように変更しました。
    * `handlePlayTurn`を修正し、プレイヤーとNPCのアクションを単一の操作でDBに書き込むように変更しました（競合状態の解消）。
    * 既存の「資金集め」ボタン（`id="gain-funds-button"`）の`onClick`ハンドラを修正し、`collect_funds`アクションをトリガーするように変更しました。
    * `HandView`コンポーネントに`playerId`プロップを渡すように修正しました。
* **`packages/web-game-client/src/game/scenes/MainGameScene.ts`**:
    * `displayPlayedCard`を修正し、`COLLECT_FUNDS_COMMAND`の場合に`GAIN_FUNDS`画像を使用するように変更しました。
    * `GAIN_FUNDS.jpg`を明示的にプリロードするように`preload`関数を修正しました。
    * `flipCard`関数を修正し、カード画像がフリップ後に正しく表示されるように`setDisplaySize`を再追加しました。

#### フェーズ3: テストとクリーンアップ

* **`packages/web-game-client/src/game/engine.test.ts`**:
    * `mockCardTemplates`から`GAIN_FUNDS`を削除しました。
    * `it('should create an initial game state correctly')`の初期資金チェックを`0`に更新しました。
    * `it('should resolve ACQUIRE vs GAIN_FUNDS correctly')`テストを削除しました。
    * `it('should not allow a player to play a card they cannot afford')`を修正し、プレイヤーがカードを支払えない場合の「資金集め」コマンドをテストするように変更しました。
    * 「資金集め」コマンドの効果を検証する新しいテスト`it('should resolve COLLECT_FUNDS command correctly')`を追加しました。
* **`packages/web-game-client/src/App.tsx`**: `GameEngine`に渡される`cardTemplates`から`GAIN_FUNDS`がフィルタリングされていることを確認しました（フェーズ2で対応済み）。

---

### 発生した問題と解決策

1.  **「資金集め」カードがまだ手札に現れる**:
    * **原因**: `cardTemplates`に「資金集め」テンプレートが含まれていたため。
    * **解決策**: `GameView.tsx`で`fetchCardTemplates`後に「資金集め」テンプレートをフィルタリングするように修正しました。
2.  **「資金集め」コマンドの画像が表示されない**:
    * **原因**: `GAIN_FUNDS.jpg`がPhaserでプリロードされていなかった、またはフリップ後の`setDisplaySize`の問題。
    * **解決策**: `MainGameScene.ts`で`GAIN_FUNDS.jpg`を明示的にプリロードし、`flipCard`関数で`setDisplaySize`を再追加しました。
3.  **NPCが「資金集め」コマンドを選択しない**:
    * **原因**: `ai.ts`の`calculate_weights`で`npcPlayer`の識別が不正確だった、および`choose_card`が`null`を返す条件が厳しすぎたため。
    * **解決策**: `ai.ts`の`calculate_weights`で`npcPlayer`の識別を修正し、`choose_card`のロジックを改善して「資金集め」コマンドを考慮するように変更しました。
4.  **`HandView.tsx: ReferenceError: playerId is not defined`**:
    * **原因**: `HandView`コンポーネントが`playerId`プロップを受け取っていなかったため。
    * **解決策**: `HandView.tsx`で`playerId`を分割代入し、`GameView.tsx`から`playerId`を渡すように修正しました。
5.  **「資金集め」コマンド選択後、ゲームが進行しない**:
    * **原因**: プレイヤーとNPCのアクションがアトミックにDBに書き込まれていなかったため（競合状態）。
    * **解決策**: `GameView.tsx`の`handlePlayTurn`で、両方のアクションを単一の`set`操作でDBに書き込むように修正しました。
6.  **ゲームログにプレイヤーのアクションが2回表示される**:
    * **原因**: `engine.ts`のログ出力で、プレイヤーとNPCの識別が固定インデックスに依存していたため。
    * **解決策**: `engine.ts`の`resolveActions`で、`playerId`と`clientId`を比較してログメッセージを生成するように修正しました。
7.  **`ai.ts`の`weights`重複宣言エラー**:
    * **原因**: `calculate_weights`と`choose_card`関数のコードが混在し、`weights`が複数回宣言されていたため。
    * **解決策**: `ai.ts`ファイル全体を正しい構造で書き直し、構文エラーと論理的な混同を解消しました。

---

### 現在の状況

* ゲームが正常に進行するようになりました。
* プレイヤーとNPCの両方のアクションが正しく処理され、ログに記録されます。
* カードのフリップアニメーションと画像表示が正しく機能します。
* NPCが「資金集め」コマンドを適切に選択するようになりました。
* `engine.test.ts`が新しいゲームロジックと「資金集め」コマンドをカバーするように更新されました。

### 開発作業の総評とコメント:

  今回の開発作業は、「鹿王院エリザベスの地上げですわ！」のゲームシステムを更新された仕様（GEMINI.md）に基づいて大幅に変
  更し、それに伴う様々なバグの修正とテストカバレッジの向上を行うものでした。

  全体的な評価:

  タスクは成功裏に完了しました。ゲームは新しい仕様（「資金集め」コマンドを含む）に従って機能し、コードベースはテストカ
  バレッジが向上し、より堅牢になりました。

  主な達成事項:

   1. 「資金集め」コマンドの実装成功:
       * 「資金集め」をカードからコマンドに移行し、そのロジックを GameEngine に統合しました。
       * 既存のボタンを使用してコマンドのUIを実装し、正しいアクションタイプ処理を保証しました。
       * NPC AIが戦略的に「資金集め」コマンドを選択できるようにしました。
   2. コアゲームロジックの整合性:
       * 新しい仕様に合わせてゲームの初期状態（資金、デッキサイズ）を調整しました。
       * 新しいコマンドを処理し、正しいターン解決を保証するために GameEngine をリファクタリングしました。
   3. UI/Phaser統合:
       * Phaserでの「資金集め」コマンドの正しい視覚表現（アニメーションを含む）を保証しました。
       * Phaserでのプレイヤー/相手のアクション表示に関する問題を解決しました。
   4. テストカバレッジの大幅な向上:
       * 主要なギャップであった ai.ts（calculate_weights、choose_card）の包括的な単体テストを追加しました。
       * engine.test.ts を新しいゲームルールを反映させ、より多くのエッジケース（例：コンストラクタハイドレーション、null
         プレイヤー、存在しないカードテンプレート、空のデッキ/捨て札）をカバーするように更新しました。
       * CIがパスするように、目標の80%グローバルブランチカバレッジを達成しました。
   5. 堅牢なデバッグと問題解決:
       * Firebase更新の競合状態、playerId の誤った属性、AIとゲームエンジンにおける微妙なロジックエラーなど、複雑な問題を
         特定し、解決しました。これには、console.log を使用した反復的なデバッグとログの慎重な分析が含まれました。

  遭遇した課題と得られた教訓:

   1. コミュニケーションと仕様解釈: 「資金集め」コマンドのUIに関する初期の誤解（新しいボタンの追加 vs.
      既存のボタンの使用）は、UI/UXの詳細を早期に明確にすることの重要性を浮き彫りにしました。
   2. アトミックなデータベース操作:
      Firebase更新の競合状態は重大なバグでした。プレイヤーとNPCの両方のアクションに対して単一のアトミックな set
      操作を実行する解決策は、リアルタイムゲームの状態管理にとって重要なパターンです。
   3. TypeScript 型安全性: Action インターフェースの変更（actionType
      が必須になったこと）は、テストで多数のコンパイルエラーを引き起こしました。これは、エラーを早期に捕捉するTypeScriptの
      型安全性の価値を再確認させましたが、インターフェースが変更された場合の徹底的なテスト更新の必要性も示しました。
   4. テストカバレッジのギャップ: 特に ai.ts の初期の低いテストカバレッジは、隠れたバグにつながり、デバッグをより困難にし
      ました。テストを追加するプロセスは、実装後にはすぐには明らかにならなかったいくつかの論理的な欠陥を明らかにしました。
      これは、実装後のステップとしてだけでなく、開発と並行してテストを作成することの重要性を強調しています。
   5. 複雑な相互作用のデバッグ:
      Reactコンポーネント、Phaser、Firebase、およびゲームエンジンの間の相互作用は、異なるレイヤー間のデータフローと状態変
      化の慎重な追跡を必要としました。反復的なログ記録と分析がこれらの問題を解決するための鍵でした。
   6. 手動 `replace` 操作: 微妙な空白/改行の違いによる replace
      の繰り返しの問題は、大きな摩擦点でした。これは、大規模で複雑なコードブロックの場合、より堅牢なコード変更ツールまたは
      異なるアプローチ（例：完全なファイルコンテンツの提供）が将来的に有益である可能性を示唆しています。

  今後の検討事項:

   * さらなるテストカバレッジ: 80%のブランチカバレッジは達成されましたが、engine.ts や cards/
     にはまだ未カバーの行やブランチがいくつかあります。本番環境に対応したゲームの場合、さらに高いカバレッジ（例：90%以上
     ）を目指すことが有益でしょう。
   * `defend.ts`: applyDefend 関数はまだプレースホルダーであり、関数カバレッジは0%です。もしプレースホルダーのままであれ
     ば、削除するか、その目的を説明するコメントを追加することを検討しても良いでしょう。
   * サーバーサイドエンジンテスト: プロジェクトが ServerAuthoritativeMode に向かって進むにつれて、Python GameEngine
     が同様に包括的なテストを持つことを保証することが最も重要になります。
   * コードコメント: コメントは控えめにしか追加されていませんが、複雑なロジック（例：resolveActions や
     calculate_weights）は、特定の決定がなぜ行われたのかを説明するより詳細なコメントから恩恵を受ける可能性があります。

  全体として、これは困難ではありましたが成功した開発サイクルであり、ゲームの機能と安定性を大幅に向上させました。

---
### 2025年8月16日 開発報告 (ゲームルールの拡張と新カードの実装)

ゲームの戦略的な深みを増すため、ルール変更と新しいカードの追加を行いました。また、それに伴うUIの改善とバグ修正も実施しました。

---

### 📝 主な開発内容

#### 1. 手札のターン毎リフレッシュルールの実装
*   **内容**: ターン終了時に手札がすべて捨て札となり、次のターン開始時に新たに3枚のカードを山札から引くように、ゲームの基本ルールを変更しました。
*   **実装**: `engine.ts`の`advanceTurn`メソッドのロジックを修正し、関連するテストケース(`engine.test.ts`)も新しい仕様に合わせて更新しました。

#### 2. 新カード2種（「賄賂」「投資」）の実装
*   **内容**: 新たに以下の2種類のカードを実装しました。
    *   **賄賂 (Bribe)**: コスト5。相手の「防衛」や「詐欺」を無視して不動産を1つ奪う、強力な攻撃カード。
    *   **投資 (Invest)**: コスト1。即座に資金を3獲得する、経済基盤を強化するカード。
*   **実装**:
    *   `types.ts`に新しいカード種別 (`BRIBE`, `INVEST`) を追加しました。
    *   `engine.ts`のカード効果解決ロジックをリファクタリングし、新しいカード間の相互作用（特に「賄賂」の優先的な効果）を正しく処理できるようにしました。
    *   AI (`ai.ts`) が新しいカードの価値を状況に応じて判断し、戦略的に使用するための重み付けロジックを追加しました。
    *   `engine.test.ts`と`ai.test.ts`に新カードの動作を保証するテストケースを追加しました。

#### 3. デッキ構成の変更
*   **内容**: 新カードの追加に伴い、標準のデッキ構成を「5種類のカード（買収, 防衛, 詐欺, 賄賂, 投資）を各2枚ずつ、合計10枚」に変更しました。
*   **実装**: `engine.ts`の`createInitialState`メソッドと、関連するテストを新しい仕様に合わせて更新しました。

#### 4. UIの改善とバグ修正
*   **カードコストの表示**: 手札のカードにコストを`「カード名:コスト」`の形式で表示するように`HandView.tsx`を修正し、視認性を向上させました。
*   **データ起因のバグ修正**: 新カードがゲームに登場しない不具合を調査し、原因がクライアントコードではなく、Firebase Realtime Databaseのカード定義データが古いことにあると特定。ユーザーにデータベースを更新していただくための具体的なJSONデータを提供し、問題を解決しました。


### 2025年8月17日 開発報告 (UI/UXの改善)

プレイヤーの戦況判断を助けるため、UIを改善し、自身の山札と捨て札の内容を確認できる機能を追加しました。

---

### 📝 主な開発内容

#### 1. 山札・捨て札確認機能の実装 (タスク47)
*   **内容**: プレイヤーが自身の山札と捨て札のエリアをクリックすることで、それぞれの内容をモーダルウィンドウで確認できる機能を実装しました。
*   **実装**:
    *   汎用的なモーダルコンポーネント (`Modal.tsx`) と、その内部に表示される情報パネル (`DeckInfo.tsx`) を新規に作成しました。
    *   `GameView.tsx` を修正し、プレイヤーのHUD（`player-deck-area`, `player-discard-area`）にクリックイベントを追加しました。
    *   クリック時にモーダルが開き、山札の場合は「カード名と枚数の一覧（順番は非公開）」が、捨て札の場合は「捨てられたカードのリスト」が表示されます。
    *   対戦相手の山札・捨て札はクリックしても反応しないようにし、プレイヤー自身の情報のみが確認可能であることを明確にしました。
*   **改善**: この機能により、プレイヤーはゲームの状況をより正確に把握し、戦略的な判断を下しやすくなりました。

### 2025年8月17日 開発報告 (デッキ管理機能の統合とゲーム開始ロジックの改善)

今回の開発スプリントでは、デッキ管理機能の統合と、ゲーム開始時のデッキ読み込みロジックの堅牢化に注力しました。これにより、プレイヤーは事前に構築したデッキを使用してゲームを開始できるようになり、ゲームの安定性が向上しました。

---

#### 📝 主な開発内容

1.  **`DeckEditForm.tsx` のリファクタリング**:
    *   `packages/web-game-client/src/components/DeckEditForm.tsx` を、`DeckBuilderPage.tsx` から `deck`, `availableCardTemplates`, `onSave`, `onCancel` の各 props を受け取る純粋なプレゼンテーションコンポーネントとしてリファクタリングしました。
    *   内部の state 管理および API 呼び出しロジックを削除し、責務を明確に分離しました。

2.  **`App.tsx` のルーティング修正**:
    *   `packages/web-game-client/src/App.tsx` において、デッキ構築画面へのナビゲーションを `DeckBuilderPage` コンポーネントに置き換えました。

3.  **`GameView.tsx` のゲーム開始ロジック改善**:
    *   `packages/web-game-client/src/components/GameView.tsx` に `hasRequiredDecks` state を導入し、ゲーム開始に必要なプレイヤーとNPCのデッキがロードされているかを管理するようにしました。
    *   ゲーム開始時に `localStorage` からプレイヤーの選択済みデッキIDを読み込み、そのIDを使用して API (`getDeck`) からデッキデータを取得するようにしました。
    *   NPCのデッキデータも `public/decks/npc_default_deck.json` から読み込むように変更しました。
    *   プレイヤーまたはNPCのデッキの読み込みに失敗した場合、またはデッキが選択されていない場合に、ゲームの初期化を停止し、適切なメッセージをUIに表示するようにしました。
    *   `GameEngine.createInitialState` のシグネチャを修正し、プレイヤーとNPCのデッキデータを直接受け取るように変更しました (`packages/web-game-client/src/game/engine.ts`)。これにより、ゲームエンジンが正しいデッキ構成で初期化されることを保証しました。
    *   Phaser ゲームの `startGame` イベントリスナー内で、デッキが利用可能であることを再確認し、`GameEngine.createInitialState` にデッキデータを渡すようにしました。
    *   UIのローディングオーバーレイを調整し、デッキの読み込み状況や、デッキが選択されていない場合にユーザーに通知するメッセージを表示するようにしました。

#### 💡 セルフレビューとコメント

*   **`DeckEditForm.tsx`**: コンポーネントの責務が明確になり、再利用性とテスト容易性が向上しました。カード枚数制限のロジックは引き続き内部で管理されており、UIの整合性を保っています。
*   **`App.tsx`**: ルーティングの変更はシンプルであり、新しいコンポーネント構造へのスムーズな移行を実現しました。
*   **`GameView.tsx`**:
    *   **堅牢なデッキ読み込み**: `localStorage`からのデッキID読み込み、APIからのデッキデータ取得、`npc_default_deck.json`からのNPCデッキ読み込み、そしてそれらの成功/失敗に応じたゲーム初期化の制御が実装されました。これにより、ゲームが不完全な状態で開始されることを防ぎます。
    *   **`hasRequiredDecks` の活用**: この state の導入により、ゲームの進行を制御するロジックがより明確になりました。
    *   **`GameEngine.createInitialState` の修正**: ゲームエンジンが外部から提供されたデッキデータで初期化されるようになったことで、柔軟性が増し、デッキ構築機能との連携が強化されました。
    *   **UIフィードバック**: デッキがロードされていない場合のユーザーへの視覚的なフィードバックが追加され、ユーザーエクスペリエンスが向上しました。
    *   **冗長なデッキフェッチの考慮**: `GameView.tsx`の`startGame`イベントリスナー内でデッキを再フェッチするロジックは、`setupMatch`で既にフェッチされているため、厳密には冗長です。しかし、これは非同期処理における状態の確実性を高めるためのものであり、プロトタイプ段階では許容範囲と判断しました。将来的な最適化の余地はあります。

---
### 2025年8月17日 開発報告 (ゲーム初期化ロジックのデバッグと安定化)

前回報告したデッキ管理機能の統合後、ゲームが正常に開始されない、特にNPCのデッキが正しく初期化されない問題が断続的に発生しました。この問題の解決に向け、詳細なデバッグと複数回にわたる修正を行いました。

---

#### 📝 主な開発内容とデバッグの過程

1.  **課題**:
    *   ゲーム開始時、NPCの山札が0枚、または手札が配られない状態でスタートしてしまう。
    *   勝利条件を満たしても、`ReferenceError`によりゲーム終了処理が実行されない。

2.  **原因分析と対策**:
    *   **状態管理のリファクタリング**: 当初、問題の原因をReactコンポーネント間の状態の受け渡しにあると仮説を立て、選択されたデッキID (`selectedDeckId`) の管理を`GameView`から親の`App`コンポーネントに引き上げるリファクタリングを行いました。これにより、コンポーネントの再マウントによる状態の喪失を防ぎ、コードの堅牢性を高めました。
    *   **デバッグログの徹底強化**: しかし、上記修正後も問題が再現したため、原因を正確に特定するためにコンソールのログ出力を全面的に見直しました。不要なログを削除し、いつ・どのデータで・どの関数が実行されたかを正確に追跡できるように、`GameView`のライフサイクル全体に詳細なログを戦略的に配置しました。
    *   **根本原因の特定**: 新しいログを分析した結果、**NPCのデッキデータ (`npc_default_deck.json`) のJSON構造が、ゲームエンジン (`engine.ts`) が期待するデータ形式と異なっていた**ことが根本原因であると判明しました。エンジンは`{ "cards": { "ACQUIRE": 2, ... } }`という形式を期待していましたが、実際には`{ "deck": ["ACQUIRE", ...] }`という配列形式になっていました。
    *   **勝利処理エラーの特定**: デバッグの過程で、勝利時に`ReferenceError: isGameOverHandledRef is not defined`というエラーが発生することも確認。これは、以前の修正で`GameView.tsx`から`isGameOverHandledRef`の`useRef`定義が誤って欠落していたことが原因でした。

3.  **修正内容**:
    *   `public/decks/npc_default_deck.json`のファイル内容を、ゲームエンジンが正しく解釈できるJSONオブジェクト形式に修正しました。
    *   `GameView.tsx`に、欠落していた`isGameOverHandledRef`の定義を再度追加しました。

#### 💡 セルフレビューとコメント

*   今回のデバッグは、Reactのライフサイクル、状態管理、そしてデータ形式の不整合といった、フロントエンド開発における典型的な問題が複雑に絡み合っていました。
*   特に、詳細なログを仕込んでコードの実行フローとデータの状態を可視化するアプローチが、根本原因の特定に非常に有効でした。
*       *   一連の修正により、ゲームの初期化ロジックは大幅に安定し、プレイヤーとNPCが意図通りにデッキを持ってゲームを開始できる状態になりました。

---

## 追記：大規模リファクタリング計画 (データ駆動型エンジンへの移行)

**目的:** 将来的なカードの追加・仕様変更に迅速かつ安全に対応できる、柔軟で保守性の高いアーキテクチャを構築する。

**背景:** 現状の`engine.ts`では、カードの効果処理ロジックが複雑な条件分岐で実装されており、新規カードの追加やバランス調整のたびに、エンジン本体のコードを修正する必要がある。これは、将来的にカードプールが増加した際に、コードの複雑化、バグの混入、開発速度の低下を招く危険性が高い。また、カードのフレーバーテキストやイラストといったメタデータを管理する統一的な仕組みも存在しない。

この課題を解決するため、以下の3つのフェーズに分けて、ゲームエンジンを「データ駆動型」のアーキテクチャへと移行するリファクタリングを実施する。

---

### **フェーズ1: カード定義の拡張とデータ移行**

**目標:** すべてのカード情報をロジックから分離し、JSONデータとして一元管理する基盤を構築する。

*   **タスク1-1: `CardTemplate`型の拡張**
    *   `types.ts`内の`CardTemplate`インターフェースを、効果ロジックのヒントや各種メタデータを含む包括的な構造に更新する。
    *   要求仕様に基づき、`serialId: string` (`XXX-YYY`形式、例: `010-001`) プロパティを追加する。
    *   `illustPath`, `flavorText`, `effect`オブジェクト（`priority`, `actions`配列などを含む）を追加する。

*   **タスク1-2: カード定義JSONファイルの作成**
    *   `packages/web-game-client/public/cards`ディレクトリを新設する。
    *   既存の5種類のカードを、新しい`CardTemplate`形式に則った個別のJSONファイルとして作成する (`010-001.json`, `010-002.json`, ...)。
    *   Firebase Realtime Databaseに格納されている古いカードテンプレートは、このフェーズの完了後に新しい形式のデータで置き換える計画とする。

*   **タスク1-3: カードテンプレート読み込み処理の修正**
    *   `realtimeClient.ts`の`fetchCardTemplates`を修正（または新しい関数を作成）し、新しいJSONファイル群を読み込んで、`{ [templateId]: CardTemplate }`形式のオブジェクトを構築するように変更する。
    *   `GameView.tsx`などがこの新しい読み込み処理を利用するように修正する。

**完了条件:** アプリケーション起動時に、新しい形式のカード定義JSONがすべて読み込まれ、`GameView`コンポーネントの`cardTemplates` stateに正しく格納されること。この時点では、ゲームロジックはまだ動作しなくてよい。

---

### **フェーズ2: 効果プラグインの実装とエンジンのリファクタリング**

**目標:** `engine.ts`からカード効果の具体的ロジックを分離し、エンジンをシンプルな「オーケストレーター」へと変換する。

*   **タスク2-1: 効果ハンドラ（プラグイン）の作成**
    *   `packages/web-game-client/src/game/effects`ディレクトリを新設する。
    *   カード定義JSONの`effect.actions.name`（例: `ACQUIRE_PROPERTY`）に対応する効果ハンドラを作成する。
    *   各ハンドラは、`GameState`と関連パラメータを受け取り、変更後の`GameState`を返す純粋な関数として実装する。

*   **タスク2-2: `engine.ts`の`resolveActions`メソッドの全面リファクタリング**
    *   既存の`resolveActions`の複雑な`if-else`ロジックを削除する。
    *   新しいロジックを実装:
        1.  プレイされた各カードの`CardTemplate`データを取得する。
        2.  `effect.priority`（優先度）に基づいて、効果を解決する順序を決定する。
        3.  決定された順序でカードの効果をループ処理する。
        4.  ループ内で、`effect.actions`配列をさらにループし、`action.name`に対応する効果ハンドラ（プラグイン）を呼び出して`GameState`を更新する。
        5.  カード間の相互作用（例: 「防衛」による「買収」の無効化）は、優先度と効果ハンドラ内での条件チェックによって処理する。

*   **タスク2-3: ユニットテストの修正・拡充**
    *   `engine.test.ts`を、新しい`resolveActions`のロジックをテストするように全面的に書き直す。
    *   各効果ハンドラに対して、個別のユニットテストを作成し、ロジックの正当性を担保する。

**完了条件:** すべての既存カードの効果が、新しいプラグイン方式で正しく再現されること。すべてのユニットテストがパスすること。

---

### **フェーズ3: 関連機能の修正とクリーンアップ**

**目標:** 新しいアーキテクチャに合わせて、影響を受ける他の機能を修正し、不要になったコードを削除する。

*   **タスク3-1: AIロジック (`ai.ts`) の修正**
    *   NPCの思考ロジックを、新しい`CardTemplate`のデータ（`effect`オブジェクトなど）を参照して、よりインテリジェントな判断を下せるように修正する。

*   **タスク3-2: UIコンポーネントの修正**
    *   `HandView.tsx`や`DeckBuilderPage.tsx`などが、新しい`CardTemplate`のデータ（`flavorText`など）を正しく表示できるように修正する（将来のカードライブラリ機能の布石）。

*   **タスク3-3: 古いコードの削除**
    *   `game/cards`ディレクトリ内の古いカード効果ファイル (`acquire.ts`など) を削除する。
    *   `engine.ts`内の不要になったヘルパーメソッドなどを削除する。

**完了条件:** ゲーム全体が新しいアーキテクチャで問題なく動作すること。コードベースから古いロジックがクリーンアップされていること。

  期間: 2025年8月20日～現在

  初期課題:
  「資金集め」コマンドが機能せず、アニメーションが表示されず、ターンが進行しない。

  デバッグプロセスと実装された解決策:

   1. `engine.ts` における構文エラー（`already declared`、`Expected ;`）:
       * 原因: checkConditions メソッドの誤った配置（resolveActions 内にネストされていた）と、以前の誤った replace
         操作による resolveActions メソッドの重複。また、currentTurnResolvedActions
         が同じスコープ内で二重に宣言されていた。
       * 解決策:
           * engine.ts の GameEngine
             クラス全体をクリーンで修正済みのバージョンに置き換え、メソッドが正しくネストされるように構造を修正。
           * スコープの競合を解決するため、重複していた currentTurnResolvedActions を playedCardsForCancellation
             にリネーム。

   2. `Card template for GAIN_FUNDS not found` エラー:
       * 原因:
           * 当初、public/cards/COLLECT_FUNDS.json が欠落していた。
           * その後、ファイルを作成しても、JSON内の templateId が "COLLECT_FUNDS" であったのに対し、engine.ts が
             "GAIN_FUNDS" を探していた。
           * Vite の永続的なキャッシュ問題により、COLLECT_FUNDS.json への変更が反映されなかった。
           * 後に、他のカードJSONファイル（ACQUIRE.json など）も public/cards
             ディレクトリから欠落しており、fetchCardTemplates がそれらを読み込もうとした際に SyntaxError: Unexpected
             token '<' が発生していたことが判明。
       * 解決策:
           * COLLECT_FUNDS.json を templateId: "GAIN_FUNDS"
             で作成。（後にユーザーのフィードバックに基づき元に戻したが、ファイル自体は存在する必要があった。）
           * engine.ts と GameView.tsx を修正し、「資金集め」コマンドの templateId として COLLECT_FUNDS
             を使用するように変更し、COLLECT_FUNDS.json ファイルと整合させた。
           * 重要な点として、欠落していたJSONファイルの問題が特定された。 list_directory
             ツールは誤解を招くものであったが、ユーザーの手動確認によりファイルが実際に欠落していたことが判明した。

   3. `TypeError: Cannot read properties of undefined (reading 'id')`:
       * 原因: engine.ts が、「資金集め」コマンド（物理的なカードではない）を手札から削除しようとしていた。
       * 解決策: engine.ts を修正し、COLLECT_FUNDS コマンドの手札からの削除をスキップし、nullチェックを追加。

   4. `engine.ts:273 applyEffect: action.name: undefined`:
       * 原因: applyEffect が action.name に直接アクセスしようとしていたが、COLLECT_FUNDS.json の effect オブジェクトには
         actions 配列があり、name は actions[0].name の中にあった。
       * 解決策: engine.ts を修正し、action.actions[0].name を使用し、action.actions[0] を gainFunds に渡すように変更。

   5. アニメーションが表示されない / ターンが進行しない（Phaser イベントシステムの問題）:
       * 原因: Phaser のグローバルレジストリにおける changedata および set イベントが、MainGameScene の
         handleRegistryChange リスナーを確実にトリガーしていなかった。これが最も永続的で困難な問題であった。
       * 解決策: GameView.tsx から mainGameScene.displayTurnActions(dbGameState.lastActions);
         を直接呼び出すことで、信頼性の低いPhaserレジストリイベントシステムをバイパス。

  現在の状況:

   * 「資金集め」コマンドは正常に機能するようになりました。
   * 資金は正しく増加しています。
   * アニメーションは表示されるようになりました。
   * ターンは進行するようになりました。
   * 以前のすべての UncaughtError は解決されました。

  残されたタスク（私の側）:

   1. すべてのデバッグ用 console.log 文を削除する。
   2. GameView.tsx から displayTurnActions への直接呼び出しを削除し、MainGameScene.ts を changedata
      イベントをリッスンするように戻す。（直接呼び出しは回避策であり、イベントシステムが機能するべきであるため。）