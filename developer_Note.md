# 開発者ノート

## 優先度Aタスク実施報告

以下の優先度Aタスクがすべて完了しました。

1.  **モノレポ初期セットアップ**: `packages/web-game-client` および `packages/api-server` ディレクトリの作成と、ルート `package.json` でのワークスペース設定が完了しました。
    *   **コメント**: `run_shell_command` ツールの `directory` パラメータと `npm` ワークスペースの連携に一部課題があり、`npm create` や `npm install` の実行に試行錯誤がありましたが、最終的には手動での実行と`npm install --workspace`コマンドの適切な利用により解決しました。

2.  **共通スキーマ定義**: `specs/game_state.json` を作成し、ゲームの状態、プレイヤー、カード、アクションの基本的なデータ構造を定義しました。
    *   **コメント**: このスキーマは、フロントエンドとバックエンド間のデータ整合性を保つ上で非常に重要です。今後の機能追加や変更の際には、このスキーマを常に最新の状態に保つ必要があります。

3.  **`NullAuthAdapter` の実装**: `packages/web-game-client/src/auth/AuthAdapter.ts` インターフェースと `packages/web-game-client/src/auth/NullAuthAdapter.ts` クラスを実装しました。これにより、認証なしの初期フェーズでも一意の `clientId` を管理できるようになりました。
    *   **コメント**: 将来的にFirebase Authenticationを導入する際に、この抽象レイヤーがスムーズな移行を可能にします。

4.  **Local Game Engine (TypeScript) とユニットテストの実装**: `packages/web-game-client/src/types.ts` で型定義を行い、`packages/web-game-client/src/game/engine.ts` でゲームエンジンの骨組みを実装しました。また、`packages/web-game-client/src/game/engine.test.ts` で基本的なユニットテストを作成し、パスすることを確認しました。
    *   **コメント**: Jestの設定で `jest.config.js` を `jest.config.cjs` にリネームする必要がありましたが、これは `package.json` の `"type": "module"` 設定によるものです。ゲームエンジンのロジックはまだプレースホルダーですが、テストが整備されたことで、今後の機能追加が安全に行える基盤ができました。

5.  **Hand UI (Reactコンポーネント) の実装**: `packages/web-game-client/src/components/HandView.tsx` を作成し、`packages/web-game-client/src/App.tsx` に統合しました。これにより、プレイヤーの手札がUIに表示されるようになりました。
    *   **コメント**: 現時点ではカードの見た目はシンプルですが、Phaser 3との統合や、カードの選択・無効化ロジックの実装に向けての足がかりとなります。

## 今後の開発に向けたコメント

*   **Realtime Database連携**: 次の優先タスクであるRealtime Databaseラッパーの実装は、クライアントとサーバー間のデータ同期の核となります。Firebaseの`firebaseConfig`情報が提供され次第、すぐに着手可能です。
*   **ゲームロジックの具体化**: 現在のゲームエンジンは骨組みのみです。カードの効果（資金獲得、買収、防衛、詐欺）を具体的に実装し、ターンの進行ロジック（資金獲得フェイズ、ドローフェイズ、アクションフェイズ）を完成させる必要があります。
*   **NPC AI**: NPCのAIロジックは、ゲームの面白さに直結します。重み付け行動型のAIを実装する際には、ゲームの状態を適切に評価し、戦略的な選択ができるように設計することが重要です。
*   **Phaser 3統合**: UIとゲーム描画の分離は良い設計ですが、Phaser 3でのカードのアニメーションやインタラクションの実装は、ゲームの体験を大きく左右します。
*   **テストの拡充**: 今後、ゲームロジックが複雑になるにつれて、ユニットテストだけでなく、統合テストやE2Eテストの導入も検討すべきです。
*   **ユーザーからの情報提供**: `TODO.md`の「確認事項・提供物」セクションにあるFirebase情報、カード画像、詳細な勝利条件の定義は、今後の開発をスムーズに進める上で不可欠です。これらの情報提供にご協力をお願いいたします。

---
以上、優先度Aタスクの完了報告と今後の開発に関するコメントです。

## 追記：フェーズ2以降の主要タスク進捗報告

### 12. ゲームロジックの実装 (ターンの進行、カード効果、勝敗判定) - 完了

*   `engine.ts`にターンの進行ロジック（資金獲得フェイズ、ドローフェイズ）を実装しました。
*   各カード（資金集め、買収、防衛、詐欺）の基本的な効果を`src/game/cards/`配下に実装しました。
*   `engine.ts`の`resolveActions`メソッドを改良し、カードのコストチェック、手札から捨て札への移動、カード効果の適用ロジックを組み込みました。
*   「買収カード同士の相打ち」ルールを含む、基本的な競合解決ロジックを`resolveActions`内に実装しました。
*   勝利条件のチェック（不動産が0になった場合）のプレースホルダーを追加しました。

### 13. カード選択UIのインタラクティブ化とコストチェック - 完了

*   `HandView.tsx`のカードをクリック可能にし、選択されたカードのIDを`App.tsx`に渡すようにしました。
*   `App.tsx`に`selectedCardId`の状態管理と`handleCardSelect`関数を実装しました。
*   プレイヤーの資金とカードのコストに基づいて、プレイ可能なカードをUI上で視覚的に区別し、選択できないカードは無効化するようにしました。
*   「Play Turn」ボタンは、カードが選択されるまで無効化されます。

### 14. Realtime Databaseとのゲーム状態同期 - 完了

*   `App.tsx`をFirebase Realtime Databaseと連携させました。
*   `NullAuthAdapter`を使用して`clientId`を生成し、`createMatch`関数で新しいマッチを作成（または既存のマッチに参加）し、`matchId`を管理するようにしました。
*   `realtimeClient.ts`に`watchGameState`関数を追加し、`App.tsx`がRealtime Databaseからゲーム状態の更新をリアルタイムで監視するようにしました。
*   `handlePlayTurn`メソッドは、プレイヤーとシミュレートされたNPCのアクションを`putAction`関数を使ってRealtime Databaseに書き込むようになりました。
*   Realtime Databaseのリスナーが両プレイヤーのアクションを検知すると、`engine.advanceTurn()`と`engine.applyAction()`が呼び出され、ゲームの状態が更新されてDBに書き戻されるようになりました。

### 解決済みの主要なエラー

*   **`ReferenceError: ref is not defined`**: `realtimeClient.ts`に`watchGameState`関数を追加し、`App.tsx`のインポート文を修正することで解決しました。
*   **`TypeError: Cannot read properties of undefined (reading 'length')`**: `HandView.tsx`で`hand`プロップが常に配列として扱われるように修正することで解決しました。
*   **`ERROR: Expected ";" but found "resolveActions"`**: `engine.ts`内のメソッドの重複定義と誤ったネストを修正し、ファイルをクリーンな状態に上書きすることで解決しました。

---
以上、ここまでの開発進捗と主要なエラー解決に関する報告です。

## 追記：GitHub Actions CIワークフローの修正報告

*   **ルートの`package.json`ファイルが見つからないエラーの解決**:
    *   GitHub Actions上で`npm install`が`package.json`を見つけられないエラーが発生しました。これは、ローカル環境で`package.json`が消失していたことが原因でした。
    *   ルートに`package.json`ファイルを再作成し、正しいワークスペース設定を記述することで解決しました。
*   **`engine.test.ts`の引数エラーの解決**:
    *   `engine.test.ts`内の`engine.applyAction`の呼び出しで、引数の数が不足しているエラーが発生しました。
    *   `applyAction`メソッドが2つの引数を取るように変更されたことに合わせて、テストコードも2つの引数を渡すように修正しました。
*   **`engine.ts`の構文エラーの解決**:
    *   `engine.ts`内でメソッドが誤ってネストされていた構文エラーが継続して発生していました。
    *   `engine.ts`ファイルを正しい内容で完全に上書きすることで、重複したメソッド定義と誤ったネストを解消し、エラーを解決しました。

これらの修正により、GitHub ActionsのCIワークフローが正常に動作し、フロントエンドのテストが自動で実行されるようになりました。

## 追記：フェーズ2以降の追加タスク進捗報告 (続き)

### 16. デッキ構築UIの実装 (フロントエンド) - 完了

*   `packages/web-game-client/src/components/DeckBuilder.tsx`を作成し、利用可能なカードの表示、デッキへの追加・削除機能を持つ基本的なUIを実装しました。
*   `packages/web-game-client/src/components/GameView.tsx`を作成し、既存のゲームUIロジックを`App.tsx`から分離しました。
*   `packages/web-game-client/src/App.tsx`を修正し、`GameView`と`DeckBuilder`コンポーネントを切り替えられるナビゲーション（ボタン）を追加しました。

### 17. カード画像表示の統合 (HandViewなど) - 完了

*   `packages/web-game-client/src/components/HandView.tsx`および`packages/web-game-client/src/components/DeckBuilder.tsx`を修正し、カードの`templateId`に対応する画像（`public/images/cards/`配下）を表示するようにしました。
*   `packages/web-game-client/src/components/GameView.tsx`を修正し、Firebase Realtime Databaseから`CardTemplate`データを`fetchCardTemplates`で取得し、`HandView`に渡すようにしました。
*   **Firebase Realtime Databaseへのデータ投入**: `CARD_TEMPLATES`のJSONデータをFirebase Realtime Databaseの`/cards/v1/templates`パスに手動で投入しました。
*   **初期手札表示の修正**: アプリ起動時に「Your Hand: No cards in hand.」と表示される問題を解決しました。`GameView.tsx`の初期化ロジックを修正し、初期ゲーム状態をDBに書き込む前に`GameEngine.advanceTurn()`を呼び出すことで、プレイヤーが初期手札を持つようにしました。
*   **画像ファイル名の修正**: `templateId`と画像ファイル名が一致していなかった問題を、ユーザーに画像ファイル名を`templateId`に合わせて変更していただくことで解決しました。

### 解決済みの主要な問題 (続き)

*   **Firebaseデータ上書き問題**: `cards`データをインポートした際に既存の`matches`データが消滅する問題が発生しましたが、これはインポート方法の誤り（ルートでの上書き）が原因でした。`matches`データが動的に再生成されることを利用し、`cards`データを再インポートし、フロントエンドアプリを再起動することで共存状態を確立しました。
*   **カード画像が表示されない問題**: 画像ファイル名が`templateId`と一致していなかったため、画像が表示されませんでした。ユーザーに画像ファイル名を`templateId`に合わせて変更していただくことで解決しました。
*   **初期手札表示の修正**: アプリ起動時に「Your Hand: No cards in hand.」と表示される問題を解決しました。`GameView.tsx`の初期化ロジックを修正し、初期ゲーム状態をDBに書き込む前に`GameEngine.advanceTurn()`を呼び出すことで、プレイヤーが初期手札を持つようにしました。

---
以上、ここまでの開発進捗と主要な問題解決に関する報告です。

## 追記：フェーズ2完了報告とフェーズ3に向けた準備

`TODO.md`に記載されていたフェーズ2のタスクがすべて完了しました。以下に主要な達成項目と、その過程で解決した問題点をまとめます。

### 18. Phaserでのゲーム要素描画 (プレイヤー、不動産、場札) - 完了

*   ReactコンポーネントからPhaserシーンへ`gameState`を連携する仕組みを確立しました。(`game.registry`を利用)
*   `MainGameScene.ts`を大幅に改良し、`gameState`の変更を検知して、プレイヤーの資金・不動産情報や、場に出されたカードの画像などを動的に描画するようにしました。
*   カード画像のアセットを`preload`で動的に読み込むようにし、ゲームのアニメーション（カードのフェードインなど）の基礎を実装しました。

### 19. デッキ管理APIの実装 (バックエンド) - 完了

*   FastAPIを用いて、デッキを管理するための基本的なAPIエンドポイント (`/decks`) を構築しました。
*   Pydanticモデル (`Deck`, `CardInDeck`) を定義し、リクエストとレスポンスのデータ構造を明確化しました。
*   当面はインメモリの辞書をデータベースとして使用しますが、将来的にFirebase等へ拡張可能な設計としました。

### 20. サーバーサイドゲームロジックの骨組み構築 (FastAPI) - 完了

*   クライアント側のTypeScript製`GameEngine`に対応する、Python版`GameEngine`のスケルトンを`api-server`側に作成しました。
*   これにより、将来的にサーバー主導の権威あるゲームロジック（特にPvPモードで重要）へ移行するための基盤が整いました。

### 22. GitHub Actions CIワークフローで実施するテストカバレージの最適化 - 完了

*   Jestの設定を更新し、`--coverage`フラグによってテストカバレッジレポートが自動生成されるようにしました。
*   カバレッジ向上のため、`engine.ts`の`applyAction`メソッドに対するより具体的なテストケースを追加し、テストの信頼性を高めました。

### 解決済みの主要な問題 (続き)

*   **ゲームオーバーループ問題**: ゲームが終了してもターンが進行し続ける問題を、`GameEngine`と`GameView`の両方にガード処理を追加することで解決しました。
*   **CIテストの失敗**: `GameEngine`のコンストラクタ変更後にテストが失敗する問題を、テストコード側で正しい`gameState`を注入するように修正して解決しました。

* UI/UXとPhaserアニメーションの洗練（タスク27）の続き:
       * game-rootの画面全体スケーリングと中央寄せの調整。
       * App.cssとmain.tsxの修正によるレイアウト調整。
       * nav-panelとgame-panelのレイアウトと色調整。
       * top-barとplayer-areaのパディング削除と位置調整。
       * hud.opponent-hudとtop-barの重なり解消。
       * GameボタンとDeck Builderボタンのスタイリング。
       * Phaser Canvasのサイズ調整と、phaser-game-containerのdivとlaunch呼び出しに関するデバッグと修正。
       * Phaser Canvas内のturnInfoTextの非表示化。
       * 未解決の問題: カードアニメーションが表示されない問題（lastActionsがPhaserに正しく伝わらない問題）。

## 追記：カードアニメーションの不具合修正報告

長らく未解決となっていた「カードアニメーションが表示されない問題」について、原因の特定と修正が完了しました。

### 発生していた問題

1.  **1ターン目のアニメーション不具合**: 両プレイヤーがカードを提出しても、片方のカードのアニメーションしか再生されない。
2.  **NPCのカードが表示されない**: アニメーション中に、NPC側のカードが表示されない。
3.  **勝敗表示の不具合**: ゲームが終了しても、「You Win / You Lose」のメッセージが表示されない。

### 根本原因

これらの問題はすべて、ゲームエンジン(`engine.ts`)の`resolveActions`メソッドにおける、**状態管理の設計不備**に起因していました。

具体的には、ターンの結果を処理する際に、現在のゲーム状態を直接変更（ミューテーション）していました。これにより、プレイヤー1の処理がプレイヤー2の処理に意図せず影響を与え、プレイヤー2の手札からカードが見つからなくなる、という深刻な副作用が発生していました。その結果、エンジンが返すアクション履歴(`lastActions`)が不完全なものとなり、アニメーションの不具合を引き起こしていました。

### 修正内容

*   **ゲームエンジンのリファクタリング**:
    *   `engine.ts`の`applyAction`メソッドの設計を全面的に見直し、**イミュータブル（不変）な状態管理**を導入しました。
    *   ターンの処理を行う際は、まず現在のゲーム状態の完全なコピーを作成し、すべての処理（コスト計算、効果適用など）をそのコピーに対して行います。
    *   これにより、処理の途中で元の状態が破壊されることがなくなり、常に安全で予測可能な結果を保証できるようになりました。

*   **アニメーションロジックの単純化**:
    *   問題の切り分けのため、`MainGameScene.ts`のカードアニメーションを一時的にシンプルなもの（移動演出の省略）に修正しました。根本原因の解決に伴い、今後より洗練された演出に戻すことも可能です。

### 結果

この修正により、上記のアニメーションに関するすべての問題が解決され、両プレイヤーのカードが正しく表示されるようになりました。長期間にわたりご迷惑をおかけしましたが、ご協力のおかげで、より堅牢で安定したゲームエンジンの基盤を構築することができました。

### 2025年8月14日 開発報告

今回の開発スプリントでは、ユーザー体験の向上とゲームの安定性・品質向上に焦点を当てました。特に、テストカバレッジを大幅に向上させたことで、今後の機能追加やバランス調整をより安全かつ迅速に行うための強固な基盤が整いました。

---

### 📝 主な開発内容

#### 1. ゲームログの日本語化とフォーマット統一
* **内容**: ゲーム内で表示されるすべてのログメッセージを英語から日本語に翻訳し、フォーマットを「プレイヤーは「（カード名）」をプレイした」という形式に統一しました。
* **改善**: 各ターンの出来事が直感的に理解できるようになり、ログ管理も`engine.ts`に集約されたことで容易になりました。

#### 2. UI/UXの改善
* **最新ログの強調表示**: ゲームログの最新項目を太字で明るく表示することで、視覚的に区別できるようにしました。
* **UIのクリーン化**: ログエリアの見出しを削除し、より洗練されたシンプルなデザインにしました。

#### 3. ゲームバランスの調整
* **ターン毎の資金増加ルールの変更**: ユーザーフィードバックに基づき、ターン開始時の自動資金増加ルールを撤廃しました。これにより、カードプレイの戦略性がさらに重要になります。

#### 4. テストの拡充と品質向上
* **テストカバレッジの大幅向上**: ゲームエンジンのテストファイル(`engine.test.ts`)を拡充しました。
* **テストシナリオ追加**: 「買収」対「防衛」、「買収」対「詐欺」といった競合シナリオや、山札が尽きた際のシャッフル、ゲーム終了条件などのエッジケースを含むテストを追加しました。
* **バグ修正**: テスト拡充の過程で発見された「片方のプレイヤーがカードを出さない場合にゲームが停止するバグ」を修正し、エンジンの安定性を向上させました。

### 2025年8月15日 開発報告

クライアントとサーバーで一貫したゲーム体験を提供するため、サーバーサイドにPython製のゲームエンジンを実装しました。

---

### 🛠️ サーバーサイドゲームエンジンの実装 (フェーズ3)

#### 1. データ構造のPython化 (タスク23a)
* **内容**: TypeScriptで定義されていたゲームの状態を、Pythonの**Pydanticモデル**として`api-server/app/game/models.py`に再定義しました。
* **効果**: Pydanticによる厳密な型チェックが可能になり、サーバーサイドでのデータの一貫性と信頼性が向上しました。

#### 2. カード効果ロジックの移植 (タスク23b)
* **内容**: 各カードの効果を処理する関数を、TypeScriptからPythonへ個別に移植し、`api-server/app/game/cards/`配下に整理しました。
* **効果**: クライアントとサーバーでカード効果の処理が完全に一致するようになりました。

#### 3. ゲームエンジン本体の移植 (タスク23c)
* **内容**: ターンの進行、アクションの解決、勝利条件の判定といった核となるロジックを`GameEngine`クラスとして`api-server/app/game/engine.py`に実装しました。
* **効果**: これにより、サーバー単体でゲームを進行できる基盤が整いました。

#### 4. サーバーサイドの単体テスト実装 (タスク23d)
* **内容**: Python版`GameEngine`が正しく動作することを保証するため、`pytest`を用いて包括的なユニットテストを`api-server/tests/test_engine.py`に作成しました。
* **効果**: クライアント側のテストケースを網羅することで、両エンジンのロジックの一貫性を担保しました。

#### 5. CI（継続的インテグレーション）の強化
* **内容**: GitHub ActionsのCIワークフローを更新し、プッシュ時にフロントエンドとバックエンド両方のテストが自動で実行されるようにしました。
* **効果**: プロジェクト全体の安定性が向上しました。

---

### 🚀 フェーズ3タスクの完了と問題解決

* **ゲームエンジンを呼び出すAPIエンドポイント作成 (タスク23e)**: FastAPIバックエンドに、ゲームエンジンの主要なメソッドを呼び出すAPIエンドポイントを実装しました。
* **デッキ管理APIのデータベース接続 (タスク24)**: デッキ管理APIを、インメモリデータベースから**Firebase Realtime Database**に移行しました。
    * **解決した問題**: `firebase-admin`パッケージの不足を`requirements.txt`に追加することで解決。また、認証情報は**.envファイル**と`.gitignore`を使い、安全に管理する仕組みを導入しました。
* **デッキ構築UIとAPIの統合 (タスク25)**: フロントエンドのデッキ構築UIが、バックエンドのデッキ管理APIと連携し、デッキの作成、読み込み、更新が可能になりました。
    * **解決した問題**: **Vite開発サーバーのプロキシ設定**を修正し、フロントエンドからバックエンドへのAPIリクエストが正しく転送されるようにしました。

### 2025年8月15日 開発報告 (描画問題の課題と今後の対策方針)

長らく課題となっていた描画問題について、原因の特定と解決策の検討を行いました。

---

### 🚧 未解決の描画問題

現在も残っている主な視覚的な問題は、**Phaserコンテナの高さがゼロに崩壊する**ことです。

* **根本原因の分析**: これは、CSSのFlexboxレイアウト、特に高さの伝播に関する問題です。
    * 親コンテナが`display: flex; flex-direction: column;`であるにもかかわらず、子要素である`.main-area`に適切な高さが伝わっていません。
    * `.main-area`が`height: 100%`を持っていても、親の高さが厳密に定義されていない場合、ゼロに縮小する可能性があります。
* **解決策の仮説**: `App.css`の`.main-area`に`flex-grow: 1`と`min-height: 0`を正しく適用することで、この問題は解決されるはずです。`flex-grow`は残りのスペースを占有する役割を、`min-height: 0`は親の高さに応じて縮小することを許可する役割を担います。

### 2025年8月15日 開発報告 (描画問題の解決と後続エラーの修正)

上記の描画問題について、原因の特定と修正を完了しました。それに伴い発生した複数の問題も解決しています。

---

### ✅ 修正内容の詳細

#### 1. Phaserコンテナの縮小問題の解決
* **原因**: `#phaser-game-container`自体の**CSSサイズが未定義**だったことが真の原因でした。
* **修正**: CSSルールに`width: 100%`, `height: 100%`, `aspect-ratio`などを追加し、コンテナが親要素内で正しくサイズを確保するようにしました。

#### 2. 空白のキャンバス問題の解決
* **原因**: ReactのStrictModeによるコンポーネントの再マウント時に、Phaserゲームインスタンスが再作成されない**ロジックの欠陥**が`GameView.tsx`にありました。
* **修正**: `isFirstMountRef`のロジックを削除し、`useEffect`フックを単純化することで、Phaserインスタンスが常に正しく再生成されるようにしました。

#### 3. Canvasのサイズ不一致問題の解決
* **原因**: Phaserの初期化コンフィグが固定ピクセルサイズ（1000x600）を基準にしていたため、動的なサイズ変更に追従できていませんでした。
* **修正**: Phaserのコンフィグの`scale`設定を`width: '100%'`, `height: '100%'`に変更し、親コンテナのサイズにフィットするようにしました。

#### 4. ランタイムエラーの解決
* **原因**: `GameEngine`クラスに、UIから呼び出される`getPlayableCards`メソッドが実装されていませんでした。
* **修正**: `engine.ts`に`getPlayableCards`メソッドを新規追加し、`GameView.tsx`の呼び出し箇所を修正しました。

### 2025年8月16日 開発報告 (UI/UXの微調整とPhaser連携の安定化)

前回の報告以降、UI/UXのさらなる改善と、ReactとPhaser間の連携を安定させるための修正を行いました。

---

### ✨ UIレイアウトと表示ロジックの修正

* **トップバーの削除**: ゲーム画面上部のトップバーを削除し、ゲーム画面の垂直方向のスペースを確保しました。
* **Phaserキャンバスのサイズ調整**: Phaserキャンバスの基準サイズを**1000x600から800x480に縮小**し、UI全体とのバランスを調整しました。
* **ゲームログの表示改善**:
    * **表示件数の制限**: 常に最新6件のみが表示されるようにロジックを修正しました。
    * **レイアウト崩れの防止**: ログエリアに固定の高さを設定し、自動スクロールが機能するようにしました。
    * **新規ログの強調表示**: 「最新の1件」だけでなく、「現在のターンで発生したすべてのログ」を強調表示するようにロジックを変更しました。

### 🤝 Phaser連携の安定化とリファクタリング

* **Phaserシーンのリファクタリング**: `MainGameScene.ts`に残存していた古いHUD描画ロジックを削除し、Phaserの責務を「カードアニメーションとゲームオーバー表示」に限定しました。
* **Reactストリクトモードに関する明確化**: 開発環境でPhaserが複数回読み込まれる現象は、Reactの**ストリクトモード**による意図的な動作であり、製品版では発生しないことを確認しました。